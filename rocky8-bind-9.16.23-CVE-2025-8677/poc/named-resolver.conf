// CVE-2025-8677 POC - Recursive Resolver Configuration
// Attempts to validate DNSKEY records (triggers vulnerability)

options {
    directory "/var/named";
    pid-file "/var/run/named/named.pid";
    session-keyfile "/var/run/named/session.key";

    listen-on port 53 { any; };
    listen-on-v6 port 53 { any; };

    allow-query { any; };

    // Enable recursion to trigger validation code
    recursion yes;

    // Enable DNSSEC validation (this triggers the vulnerable code path)
    dnssec-enable yes;
    dnssec-validation no;  // Disable automatic validation, we'll trigger it manually

    // Disable query logging for cleaner output
    querylog no;
};

// Logging configuration
logging {
    channel default_log {
        file "/var/log/named/default.log" versions 3 size 5m;
        severity debug 3;  // Increased verbosity to see validation
        print-time yes;
        print-severity yes;
        print-category yes;
    };

    channel security_log {
        file "/var/log/named/security.log" versions 3 size 5m;
        severity info;
        print-time yes;
    };

    channel dnssec_log {
        file "/var/log/named/dnssec.log" versions 3 size 5m;
        severity debug 3;  // Detailed DNSSEC logs
        print-time yes;
    };

    category default { default_log; };
    category security { security_log; };
    category dnssec { dnssec_log; };
    category resolver { default_log; };
};

// Stub zone pointing to our authoritative server
// This makes the resolver query the authoritative server directly
zone "example.com" IN {
    type stub;
    masters { 172.25.0.5; };  // Authoritative server
    file "stub-example.com";
};

// Root hints (minimal for testing)
zone "." IN {
    type hint;
    file "root.hint";
};
