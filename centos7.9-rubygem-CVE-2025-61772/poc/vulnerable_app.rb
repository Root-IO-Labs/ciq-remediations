#!/usr/bin/env ruby
# Vulnerable Rack Application for CVE-2025-61772 Testing
# This is a simple Rack app that accepts multipart uploads

require 'rack'

class VulnerableApp
  def call(env)
    case env['PATH_INFO']
    when '/upload'
      handle_upload(env)
    when '/health'
      [200, { 'Content-Type' => 'text/plain' }, ['OK']]
    else
      [404, { 'Content-Type' => 'text/plain' }, ['Not Found']]
    end
  end

  private

  def handle_upload(env)
    begin
      # This will trigger the multipart parsing
      request = Rack::Request.new(env)
      
      # Try to parse multipart data
      params = request.params
      
      if params['file']
        file = params['file']
        filename = file[:filename] rescue 'unknown'
        size = file[:tempfile].size rescue 0
        
        [200, { 'Content-Type' => 'application/json' }, 
         ["{\"status\":\"success\",\"filename\":\"#{filename}\",\"size\":#{size}}"]]
      else
        [200, { 'Content-Type' => 'application/json' }, 
         ["{\"status\":\"success\",\"message\":\"No file uploaded\"}"]]
      end
    rescue Rack::Multipart::Error => e
      # Patched version will raise this error
      [400, { 'Content-Type' => 'application/json' }, 
       ["{\"status\":\"error\",\"message\":\"#{e.message.gsub('"', '\\"')}\"}"]]
    rescue => e
      # Catch any other errors
      [500, { 'Content-Type' => 'application/json' }, 
       ["{\"status\":\"error\",\"message\":\"#{e.class}: #{e.message.gsub('"', '\\"')}\"}"]]
    end
  end
end

if __FILE__ == $0
  require 'rack/handler/webrick'
  
  puts "╔════════════════════════════════════════════════════════════════╗"
  puts "║  Rack Multipart Upload Test Server                            ║"
  puts "╚════════════════════════════════════════════════════════════════╝"
  puts ""
  puts "Rack Version: #{Rack.release}"
  puts "Listening on: http://0.0.0.0:9292"
  puts ""
  puts "Endpoints:"
  puts "  POST /upload  - Multipart file upload"
  puts "  GET  /health  - Health check"
  puts ""
  puts "Press Ctrl+C to stop"
  puts ""

  Rack::Handler::WEBrick.run(
    VulnerableApp.new,
    Port: 9292,
    Host: '0.0.0.0',
    Logger: WEBrick::Log.new($stderr, WEBrick::Log::ERROR),
    AccessLog: []
  )
end


