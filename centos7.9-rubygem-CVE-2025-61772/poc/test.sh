#!/bin/bash
set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "╔════════════════════════════════════════════════════════════════╗"
echo "║  CVE-2025-61772 PoC Test Suite                                ║"
echo "║  Memory Exhaustion via Multipart Parser                       ║"
echo "╚════════════════════════════════════════════════════════════════╝"
echo ""

# Build images
echo -e "${BLUE}[1/5]${NC} Building Docker images..."
echo ""

# Copy the patched gem into the build context
echo "Preparing build context..."
if [ ! -f "../rack-2.0.9.1-complete-fix.gem" ]; then
    echo -e "${RED}✗${NC} Error: Patched gem not found in parent directory"
    echo "Please ensure rack-2.0.9.1-complete-fix.gem exists in deliverable/"
    exit 1
fi
cp ../rack-2.0.9.1-complete-fix.gem . 2>/dev/null || true
echo -e "${GREEN}✓${NC} Build context prepared (using complete-fix patch)"

echo "Building vulnerable image (Rack 2.0.9.0)..."
docker build -t cve-2025-61772-vulnerable -f Dockerfile.vulnerable . > /dev/null
echo -e "${GREEN}✓${NC} Vulnerable image built"

echo "Building patched image (Rack 2.0.9.1 with Complete Fix)..."
docker build -t cve-2025-61772-patched -f Dockerfile.patched . > /dev/null
echo -e "${GREEN}✓${NC} Patched image built"

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "${BLUE}[2/5]${NC} Testing VULNERABLE version (Rack 2.0.9.0)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Start vulnerable container
echo "Starting vulnerable server..."
VULN_CONTAINER=$(docker run -d -p 9292:9292 cve-2025-61772-vulnerable)
echo "Container ID: $VULN_CONTAINER"

# Wait for server to start
echo "Waiting for server to start..."
sleep 3

# Check if server is responding
echo "Checking server health..."
for i in {1..10}; do
    if curl -s http://localhost:9292/health > /dev/null 2>&1; then
        echo -e "${GREEN}✓${NC} Server is running"
        break
    fi
    if [ $i -eq 10 ]; then
        echo -e "${RED}✗${NC} Vulnerable server failed to start"
        docker logs $VULN_CONTAINER
        docker stop $VULN_CONTAINER > /dev/null
        docker rm $VULN_CONTAINER > /dev/null
        exit 1
    fi
    sleep 1
done

# Run exploit against vulnerable version
echo ""
echo "Running exploit against VULNERABLE version..."
echo ""

set +e  # Temporarily disable exit on error
ruby exploit.rb http://localhost:9292/upload
VULN_EXIT_CODE=$?
set -e  # Re-enable exit on error

if [ $VULN_EXIT_CODE -eq 0 ]; then
    # Exit 0 = PROTECTED (unexpected for a vulnerable version!)
    echo ""
    echo -e "${YELLOW}⚠️  Unexpected: Vulnerable version appears protected!${NC}"
    VULN_RESULT="PROTECTED"
elif [ $VULN_EXIT_CODE -eq 1 ]; then
    # Exit 1 = VULNERABLE (expected for vulnerable version)
    echo ""
    echo -e "${RED}✓ Expected: Vulnerable version IS VULNERABLE to CVE-2025-61772${NC}"
    VULN_RESULT="VULNERABLE"
else
    # Other exit codes
    echo ""
    echo -e "${YELLOW}⚠️  Unexpected exit code: $VULN_EXIT_CODE${NC}"
    VULN_RESULT="UNKNOWN"
fi

# Stop vulnerable container
echo ""
echo "Stopping vulnerable server..."
docker stop $VULN_CONTAINER > /dev/null
docker rm $VULN_CONTAINER > /dev/null

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "${BLUE}[3/5]${NC} Testing PATCHED version (Rack 2.0.9.1 + Complete Fix)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Start patched container
echo "Starting patched server..."
PATCHED_CONTAINER=$(docker run -d -p 9292:9292 cve-2025-61772-patched)
echo "Container ID: $PATCHED_CONTAINER"

# Wait for server to start
echo "Waiting for server to start..."
sleep 3

# Check if server is responding
echo "Checking server health..."
for i in {1..10}; do
    if curl -s http://localhost:9292/health > /dev/null 2>&1; then
        echo -e "${GREEN}✓${NC} Server is running"
        break
    fi
    if [ $i -eq 10 ]; then
        echo -e "${RED}✗${NC} Patched server failed to start"
        docker logs $PATCHED_CONTAINER
        docker stop $PATCHED_CONTAINER > /dev/null
        docker rm $PATCHED_CONTAINER > /dev/null
        exit 1
    fi
    sleep 1
done

# Run exploit against patched version
echo ""
echo "Running exploit against PATCHED version..."
echo ""

set +e  # Temporarily disable exit on error
ruby exploit.rb http://localhost:9292/upload
PATCHED_EXIT_CODE=$?
set -e  # Re-enable exit on error

if [ $PATCHED_EXIT_CODE -eq 0 ]; then
    # Exit 0 = PROTECTED (expected for patched version)
    echo ""
    echo -e "${GREEN}✅ Expected: Patched version successfully blocked all attacks!${NC}"
    PATCHED_RESULT="PROTECTED"
elif [ $PATCHED_EXIT_CODE -eq 1 ]; then
    # Exit 1 = VULNERABLE (unexpected for patched version!)
    echo ""
    echo -e "${RED}⚠️  Unexpected: Patched version is STILL VULNERABLE!${NC}"
    PATCHED_RESULT="VULNERABLE"
else
    # Other exit codes
    echo ""
    echo -e "${YELLOW}⚠️  Unexpected exit code: $PATCHED_EXIT_CODE${NC}"
    PATCHED_RESULT="UNKNOWN"
fi

# Stop patched container
echo ""
echo "Stopping patched server..."
docker stop $PATCHED_CONTAINER > /dev/null
docker rm $PATCHED_CONTAINER > /dev/null

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "${BLUE}[4/5]${NC} Cleaning up..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Clean up the copied gem file
rm -f rack-2.0.9.1-mcp-fixed-patched.gem 2>/dev/null || true

echo "Docker images retained for future testing"
echo "To remove: docker rmi cve-2025-61772-vulnerable cve-2025-61772-patched"

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║  FINAL RESULTS - CVE-2025-61772                                ║"
echo "╚════════════════════════════════════════════════════════════════╝"
echo ""
echo "Vulnerable Version (Rack 2.0.9.0):"
if [ "$VULN_RESULT" = "VULNERABLE" ]; then
    echo -e "  Status: ${RED}❌ VULNERABLE${NC}"
    echo "  Result: Accepts unbounded multipart data"
    echo "  Risk:   Memory exhaustion DoS possible"
else
    echo -e "  Status: ${YELLOW}⚠️  $VULN_RESULT${NC}"
    echo "  Result: Some protections present"
fi

echo ""
echo "Patched Version (Rack 2.0.9.1 + Complete Fix):"
if [ "$PATCHED_RESULT" = "PROTECTED" ]; then
    echo -e "  Status: ${GREEN}✅ PROTECTED${NC}"
    echo "  Result: Rejects unbounded multipart data"
    echo "  Fix:    16KB boundary limit, 64KB header limit"
else
    echo -e "  Status: ${RED}⚠️  $PATCHED_RESULT${NC}"
fi

echo ""
echo "CVE Details:"
echo "  ID:       CVE-2025-61772"
echo "  CWE:      CWE-400 (Uncontrolled Resource Consumption)"
echo "  Severity: 7.5 HIGH"
echo "  Vector:   CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H"
echo ""
echo "Security Limits (Patched):"
echo "  BOUNDARY_START_LIMIT:        16 KB"
echo "  MIME_HEADER_BYTESIZE_LIMIT:  64 KB"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Test completed successfully!"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

