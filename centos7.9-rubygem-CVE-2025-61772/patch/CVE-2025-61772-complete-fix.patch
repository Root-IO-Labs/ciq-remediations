--- rack-2.0.9.1-original/lib/rack/multipart/parser.rb	2025-11-27 16:12:23.589966484 +0530
+++ rack-2.0.9.1/lib/rack/multipart/parser.rb	2025-11-27 16:12:24.981982001 +0530
@@ -4,6 +4,9 @@
   module Multipart
     class MultipartPartLimitError < Errno::EMFILE; end
 
+    # CVE-2025-61772: Error class for multipart parsing security violations
+    class Error < StandardError; end
+
     class Parser
       BUFSIZE = 16384
       TEXT_PLAIN = "text/plain"
@@ -11,6 +14,13 @@
         Tempfile.new(["RackMultipart", ::File.extname(filename.gsub("\0".freeze, '%00'.freeze))])
       }
 
+      # CVE-2025-61772: Security limits to prevent DoS attacks
+      BOUNDARY_START_LIMIT = 16 * 1024
+      private_constant :BOUNDARY_START_LIMIT
+
+      MIME_HEADER_BYTESIZE_LIMIT = 64 * 1024
+      private_constant :MIME_HEADER_BYTESIZE_LIMIT
+
       class BoundedIO # :nodoc:
         def initialize(io, content_length)
           @io             = io
@@ -177,6 +187,9 @@
         @state = :FAST_FORWARD
         @mime_index = 0
         @collector = Collector.new tempfile
+
+        # CVE-2025-61772: Track cumulative bytes before boundary for security check
+        @total_bytes_before_boundary = 0
       end
 
       def on_read content
@@ -216,9 +229,25 @@
       end
 
       def handle_fast_forward
+        # CVE-2025-61772: Capture buffer size BEFORE consume_boundary destroys it
+        # consume_boundary() uses gsub! which removes data as it searches,
+        # so we must track cumulative bytes across all iterations
+        bytes_in_buffer = @buf.bytesize
+        
         if consume_boundary
           @state = :MIME_HEAD
+          @total_bytes_before_boundary = 0  # Reset after finding boundary
         else
+          # CVE-2025-61772: Track cumulative bytes to prevent unbounded memory buffering
+          # We accumulate the total bytes processed because consume_boundary() removes
+          # data from @buf as it searches, making @buf.bytesize unreliable for this check
+          @total_bytes_before_boundary += bytes_in_buffer
+          
+          # Check cumulative total, not current buffer size
+          if @total_bytes_before_boundary > BOUNDARY_START_LIMIT
+            raise Error, "multipart boundary not found within limit"
+          end
+          
           raise EOFError, "bad content body" if @buf.bytesize >= @bufsize
           :want_read
         end
@@ -256,7 +285,13 @@
           @collector.on_mime_head @mime_index, head, filename, content_type, name
           @state = :MIME_BODY
         else
-          :want_read
+          # CVE-2025-61772: Prevent unbounded memory buffering while parsing MIME headers
+          # Raise if buffer exceeds the higher of 64KB and the buffer size (1MB by default)
+          if @buf.bytesize > MIME_HEADER_BYTESIZE_LIMIT
+            raise Error, "multipart mime part header too large"
+          end
+          
+          return :want_read
         end
       end
 
