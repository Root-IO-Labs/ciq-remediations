#!/bin/bash
# CVE-2025-21587 POC - Rocky Linux 9 Comparison Test

set -e
cd "$(dirname "$0")"

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║   CVE-2025-21587 POC - Rocky Linux 9                          ║"
echo "║   Comparing VULNERABLE vs PATCHED Java                        ║"
echo "╚════════════════════════════════════════════════════════════════╝"
echo ""

# Test 1: Vulnerable
echo "════════════════════════════════════════════════════════════════"
echo "  TEST 1: VULNERABLE VERSION (Default Rocky 9 Java)"
echo "════════════════════════════════════════════════════════════════"
echo ""
echo "[1/4] Building vulnerable image..."
docker build -q -t cve-test-vulnerable-el9 -f Dockerfile.test . > /dev/null 2>&1 && echo "[✓] Build complete"
echo ""
echo "[2/4] Running POC (~30 seconds)..."
echo "────────────────────────────────────────────────────────────────"
docker run --rm cve-test-vulnerable-el9 2>&1 | tee /tmp/vulnerable-el9.txt
echo ""

# Test 2: Patched
echo "════════════════════════════════════════════════════════════════"
echo "  TEST 2: PATCHED VERSION (Custom RPM with CVE Fix)"
echo "════════════════════════════════════════════════════════════════"
echo ""
echo "[3/4] Building patched image..."
docker build -q -t cve-test-patched-el9 -f Dockerfile.patched-rpm . > /dev/null 2>&1 && echo "[✓] Build complete"
echo ""
echo "[4/4] Running POC (~30 seconds)..."
echo "────────────────────────────────────────────────────────────────"
docker run --rm cve-test-patched-el9 2>&1 | tee /tmp/patched-el9.txt
echo ""

# Summary
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║                    SUMMARY - Rocky 9                          ║"
echo "╚════════════════════════════════════════════════════════════════╝"
echo ""
VULN=$(grep -E "VULNERABLE|PATCHED" /tmp/vulnerable-el9.txt | head -1 | sed 's/\x1b\[[0-9;]*m//g')
PATCH=$(grep -E "VULNERABLE|PATCHED" /tmp/patched-el9.txt | head -1 | sed 's/\x1b\[[0-9;]*m//g')
echo "Vulnerable version: $VULN"
echo "Patched version:    $PATCH"
echo ""
echo "════════════════════════════════════════════════════════════════"
